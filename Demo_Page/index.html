<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Summarization Page</title>
</head>
<body>
    <div class="file-menu" id="uploaded-files-menu">
        <button class="file-menu-title" onclick="toggleMenu('uploaded-files-menu')">
            Accepted Files
        </button>
        <input type="file" id="fileUpload" accept=".pdf" style="display:none;">
        <button onclick="document.getElementById('fileUpload').click();">Upload Here</button>
        <ul id="uploaded-file-list"></ul>
    </div>

    <div class="left-panel" id="left-panel">
        <div class="pdf-container" id="pdf-container">
            <p>Select a PDF to preview it here.</p>
        </div>
    </div>

    <div class="resize-bar" id="resize-bar-2"></div>

    <div class="file-menu" id="generated-files-menu">
        <button class="file-menu-title" onclick="toggleMenu('generated-files-menu')">
            Generated Files
        </button>
        <ul id="generated-file-list"></ul>
    </div>

    <div class="right-panel" id="right-panel">
        <div class="pdf-container" id="text-container">
            <button id="accept-button" onclick="">Accept Output</button>
            <p>Document Viewer</p>
        </div>
        <button id="logout-button" onclick="logOut()">Log Out</button>
        <button style="position: absolute; bottom: 10px; right: 10px;" 
                onclick="toggleChat()">Chat</button>
        <div class="chat-overlay" id="chat-overlay">
            <div class="chat-header">
                <span>Chat</span>
                <button style="background: none; border: none; color: white; cursor: pointer;" 
                        onclick="toggleChat()">X</button>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('hidden');
        }

        function toggleChat() {
            const chatOverlay = document.getElementById('chat-overlay');
            chatOverlay.classList.toggle('open');
        }
        
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const chatOverlay = document.getElementById('chat-overlay');
                if (chatOverlay.classList.contains('open')) {
                    toggleChat();
                }
            }
        });
        const chatMessages = document.getElementById('chat-messages');
        function generateText(inputs) {
            return fetch(`https://us-central1-praximai-438817.cloudfunctions.net/get_request`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'generate_text',
                    input_prompt: inputs,
                }),
                mode: 'cors'
            })
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(json => {
                const response_result = json.result;
                console.log('API Response Result:', response_result);
                return response_result;
            })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
            });
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                const newMessage = document.createElement('p');
                newMessage.innerHTML = `<strong>You:</strong> ${message}`;
                chatMessages.appendChild(newMessage);
                input.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;                
                generateText(message).then(result => {
                    const nextMessage = document.createElement('p');
                    nextMessage.innerHTML = `<strong>Praxim:</strong> ${result}`;
                    chatMessages.appendChild(nextMessage);
                    input.value = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;                          
                });
            }
        }

        document.getElementById('chat-input').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        const resizeBar2 = document.getElementById('resize-bar-2');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        let isDragging = false;
        let startX;

        resizeBar2.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;

            const initialLeftWidth = leftPanel.getBoundingClientRect().width;
            const initialRightWidth = rightPanel.getBoundingClientRect().width;

            const onMouseMove = (event) => {
                if (isDragging) {
                    const deltaX = event.clientX - startX;
                    const newLeftWidth = initialLeftWidth + deltaX;
                    const newRightWidth = initialRightWidth - deltaX;

                    if (newLeftWidth >= 0 && newRightWidth >= 0) {
                        leftPanel.style.flex = `${newLeftWidth} 1 0%`;
                        rightPanel.style.flex = `${newRightWidth} 1 0%`;
                    }
                }
            };

            const onMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    </script>
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZvsBcAoIJLbQc4yINQz78oyCovB4RDTA",
            authDomain: "praximai-438817.firebaseapp.com",
            projectId: "praximai-438817",
            storageBucket: "praximai-438817.appspot.com",
            messagingSenderId: "274586621759",
            appId: "1:274586621759:web:b9f20b3da3329327eba58a",
            measurementId: "G-EQ7HTDC8T3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const fileCollection = collection(db, 'pdfFiles');

        // Handle authentication
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = "../";
            }
        });

        // Logout function
        window.logOut = function() {
            auth.signOut().then(() => {
                window.location.href = "../";
            }).catch((error) => {
                console.error("Error during logout", error);
            });
        };

        // upload documents
        const pdfUpload = document.getElementById('fileUpload');
        pdfUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        alert('You must be logged in to upload files.');
                        return;
                    }
                    const modifiedFileName = user.uid + '_' + file.name;
                    const storageRef = ref(storage, 'documents/' + modifiedFileName);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    await addDoc(fileCollection, {
                        name: file.name,
                        storageName: modifiedFileName,
                        url: url,
                        uid: user.uid,
                        isOriginal: true
                    });
                    console.log('Uploaded and added to Firestore:', file.name);
                    listDocuments();
                    await uploadGeneration(file.name, url);
                    listGenerateDocuments();
                } catch (error) {
                    console.error('Upload failed:', error);
                }
            } else {
                alert('Please upload a PDF file.');
            }
        });
        
        // create ORIGINAL list
        import { query, where, and} from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        const fileMenu = document.getElementById('uploaded-file-list');
        async function listDocuments() {
            const user = auth.currentUser;
            if (!user) {
                console.log('No user signed in.');
                return;
            }
            
            try {
                fileMenu.innerHTML = '';
                const q = query(fileCollection, and(
                    where("uid", "==", user.uid),
                    where("isOriginal", "==", true)
                ));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnapshot) => {
                    const fileData = docSnapshot.data();
                    addToFileMenu(fileData.name, fileData.url);
                });
            } catch (error) {
                console.error('Error listing documents:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', listDocuments);

        // add to file menu
        function addToFileMenu(fileName, fileUrl) {
            const li = document.createElement('li');
            li.textContent = fileName;

            li.addEventListener('click', () => displayPDF(fileName, fileUrl));
            fileMenu.appendChild(li);
        }

        // create GENERATE list
        async function listGenerateDocuments() {
            const user = auth.currentUser;
            if (!user) {
                console.log('No user signed in.');
                return;
            }
            
            try {
                generateMenu.innerHTML = '';
                const q = query(fileCollection, and(
                    where("uid", "==", user.uid),
                    where("isOriginal", "==", false)
                ));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnapshot) => {
                    const fileData = docSnapshot.data();
                    addToGenerateMenu(fileData.name, fileData.url);
                });
            } catch (error) {
                console.error('Error listing documents:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', listGenerateDocuments);

        // add to generate menu
        const generateMenu = document.getElementById('generated-file-list');
        function addToGenerateMenu(fileName, fileUrl) {
            const gen_li = document.createElement('li');
            gen_li.textContent = fileName;

            gen_li.addEventListener('click', () => displayGeneratedText(fileName, fileUrl));
            generateMenu.appendChild(gen_li);
        }
                // display the current original pdf
        const pdfContainer = document.getElementById('pdf-container');

        function displayPDF(fileName, fileUrl) {
            fetch(fileUrl)
                .then((response) => response.arrayBuffer())
                .then((pdfData) => {
                    pdfjsLib.getDocument({ data: pdfData }).promise.then((pdf) => {
                        pdfContainer.innerHTML = ''; 
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const canvas = document.createElement('canvas');
                            canvas.style.display = 'block';
                            canvas.style.margin = '10px 10px';
                            pdfContainer.appendChild(canvas);
                            renderPage(pdf, i, canvas);
                        }
                    });
                })
                .catch((error) => {
                    console.error('Error displaying PDF:', error);
                });
        }

        // Render individual page with scaling
        function renderPage(pdf, pageNumber, canvas) {
            pdf.getPage(pageNumber).then((page) => {
                const containerWidth = pdfContainer.clientWidth;  // Get the container's width
                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;  // Calculate scale to fit the width
                const scaledViewport = page.getViewport({ scale });

                const context = canvas.getContext('2d');
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;

                page.render({ canvasContext: context, viewport: scaledViewport }).promise;
            });
        }

        const textContainer = document.getElementById('text-container');
        
        function displayGeneratedText(fileName, fileUrl) {
            fetch(fileUrl)
                .then((response) => {
                    if (!response.ok) {
                        console.log(fileUrl)
                        throw new Error('Failed to fetch the text file');
                    }
                    return response.text(); 
                })
                .then((text) => {
                    textContainer.innerHTML = ''; 
                    const preElement = document.createElement('pre');
                    preElement.style.whiteSpace = 'pre-wrap';
                    preElement.textContent = text;
                    textContainer.appendChild(preElement);
                })
                .catch((error) => {
                    console.error('Error displaying text file:', error);
                });
        }

        // update the generated storage
        async function uploadGeneration(filename, fileUrl) {
            try {
                const summaryText = await generateSummary(fileUrl);
                const user = auth.currentUser;
                if (!user) {
                    alert('You must be logged in to upload files.');
                    return;
                }
                const textBlob = new Blob([summaryText], { type: 'text/plain' });
                const modifiedFileName = user.uid + '_' + filename + '_summary.txt';
                const modName = filename.replace(/\.pdf$/i, "") + "_generated";
                const storageRef = ref(storage, 'texts/' + modifiedFileName);
                await uploadBytes(storageRef, textBlob);
                const url = await getDownloadURL(storageRef);
                await addDoc(fileCollection, {
                    name: modName,
                    storageName: modifiedFileName,
                    url: url,
                    uid: user.uid,
                    isOriginal: false
                });
            }  catch (error) {
                console.error('Upload failed:', error);
            }
        }

        // call summarize function to create generated text
        function generateSummary(fileUrl) {
            return fetch(`https://us-central1-praximai-438817.cloudfunctions.net/get_request`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'generate_summary',
                    input_prompt: fileUrl,
                }),
                mode: 'cors'
            })
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(json => {
                const response_result = json.result;
                console.log('API Response Result:', response_result);
                return response_result;
            })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
            });
        }
    </script>
</body>
</html>