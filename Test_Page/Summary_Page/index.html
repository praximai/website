<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase PDF Upload with Modules</title>
</head>
<body>
    <input type="file" id="fileUpload" accept=".pdf" style="display:none;" onchange="uploadPDF()">
    <button onclick="document.getElementById('fileUpload').click();">Upload PDF</button>
    <button onclick="logOut()">Log Out</button>
    <h2>Uploaded Documents</h2>
    <ul id="fileList"></ul>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZvsBcAoIJLbQc4yINQz78oyCovB4RDTA",
            authDomain: "praximai-438817.firebaseapp.com",
            projectId: "praximai-438817",
            storageBucket: "praximai-438817.appspot.com",
            messagingSenderId: "274586621759",
            appId: "1:274586621759:web:b9f20b3da3329327eba58a",
            measurementId: "G-EQ7HTDC8T3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const fileCollection = collection(db, 'pdfFiles');

        // Function to upload a PDF
        async function uploadPDF() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            const auth = getAuth();

            if (file) {
                const storageRef = ref(storage, 'documents/' + file.name);
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        alert('You must be logged in to upload files.');
                        return;
                    }
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    await addDoc(fileCollection, {
                        name: file.name,
                        url: url,
                        uid: user.uid // Save the user UID with the file metadata
                    });

                    console.log('Uploaded and added to Firestore:', file.name);
                    listDocuments();  // Refresh the file list after uploading
                } catch (error) {
                    console.error('Upload failed:', error);
                }
            }
        }

        // Function to list uploaded documents
        import { query, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        async function listDocuments() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            const auth = getAuth();
            const user = auth.currentUser;

            if (!user) {
                console.log('No user signed in.');
                return;
            }

            try {
                // Create a query against the collection
                const q = query(fileCollection, where("uid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach((doc) => {
                    const fileData = doc.data();

                    // Create a list item
                    const li = document.createElement('li');
                    // Create a link to the PDF
                    const link = document.createElement('a');
                    link.textContent = fileData.name;
                    link.href = fileData.url;
                    link.target = '_blank'; // Open the PDF in a new tab
                    link.rel = 'noopener noreferrer'; // Security best practices
                    // Create a delete button for each document
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = async function () {
                        try {
                            // Delete from storage
                            const storageRef = ref(storage, 'documents/' + fileData.name);
                            await deleteObject(storageRef);
                            // Delete from Firestore
                            await deleteDoc(doc(fileCollection, doc.id));
                            // Remove the list item from the DOM
                            fileList.removeChild(li);
                            console.log('File and metadata deleted successfully.');
                        } catch (error) {
                            console.error('Error deleting document/file:', error);
                            alert('Error deleting the file. Please try again.');
                        }
                    };
                    // Append the link and delete button to the list item
                    li.appendChild(link);
                    li.appendChild(deleteButton);
                    fileList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing documents:', error);
            }
        }

        // Load the documents list when the page loads
        document.addEventListener('DOMContentLoaded', listDocuments);
    </script>
</body>
</html>